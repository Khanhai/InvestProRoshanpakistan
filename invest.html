<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Invest | InvestPro</title>
<link rel="icon" href="favicon.ico">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
<style>
:root{
  --primary-color:#FFA500;
  --bg-color:#fff;
  --text-color:#333;
  --header-height:70px;
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Inter',sans-serif;}
body{background: var(--bg-color); color: var(--text-color); line-height:1.6; display:flex; flex-direction:column; min-height:100vh;}

/* Page Loader */
#pageLoader {
  position: fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(255,255,255,0.95); display:flex; flex-direction:column; justify-content:center; align-items:center;
  z-index:3000;
}
#pageLoader .spinner {
  width:60px; height:60px; border:5px solid #fff; border-top:5px solid var(--primary-color);
  border-radius:50%; animation:spin 1s linear infinite; margin-bottom:1rem;
}
#pageLoader .text {color:var(--primary-color); font-weight:600; font-size:1rem;}

/* Header */
header{
  height: var(--header-height);
  display:flex;
  justify-content: space-between;
  align-items:center;
  padding:0 2rem;
  background: var(--bg-color);
  position: sticky;
  top:0;
  z-index:1000;
  box-shadow:0 2px 10px rgba(0,0,0,0.05);
}
header .logo{
  font-size:1.5rem;
  font-weight:700;
  display:flex;
  flex-direction: column;
  line-height:1.1;
  color: var(--primary-color);
}
header .logo small{font-size:0.8rem;font-weight:400;color:#555;}
header .dashboard-btn{
  background: var(--primary-color);
  color:#fff;
  padding:0.5rem 1.2rem;
  border-radius:25px;
  text-decoration:none;
  display:flex;
  align-items:center;
  gap:0.5rem;
  font-weight:600;
  transition: transform 0.3s, box-shadow 0.3s;
}
header .dashboard-btn:hover{transform:scale(1.05); box-shadow:0 4px 15px rgba(255,165,0,0.4);}

/* Container */
main{flex:1; opacity:0; transition: opacity 0.5s ease;}
.invest-container{
  max-width:900px;
  margin:2rem auto;
  padding:2rem;
  background:#fff5e6;
  border-radius:15px;
  box-shadow:0 8px 25px rgba(0,0,0,0.05);
  animation:fadeIn 1s ease;
}
.invest-container h2{color: var(--primary-color); margin-bottom:1.5rem; text-align:center;}

/* Payment Method Box */
.payment-method-box{
  background:#fff3e0;
  border-left:5px solid var(--primary-color);
  padding:1rem 1.5rem;
  margin-bottom:1.5rem;
  display:flex;
  flex-direction:column;
  gap:0.5rem;
  border-radius:10px;
  max-width:400px;
  word-break: break-word;
}
.payment-method-box div{display:flex; align-items:center; gap:0.5rem;}
.payment-method-box span{font-weight:600; word-break: break-word;}
.copy-btn{
  padding:0.3rem 0.6rem;
  background: var(--primary-color);
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-size:0.85rem;
  margin-left:0.5rem;
  transition: all 0.3s;
}
.copy-btn:hover{opacity:0.85; transform:scale(1.05);}

/* Form */
.form-group{display:flex; flex-direction: column; margin-bottom:1rem;}
.form-group label{margin-bottom:0.3rem;font-weight:600;}
.form-group input, .form-group select{
  padding:0.8rem 1rem;
  border:1px solid #ccc;
  border-radius:10px;
  outline:none;
  transition:border 0.3s;
}
.form-group input:focus, .form-group select:focus{border-color: var(--primary-color);}

.btn-container{position:relative; margin-top:1rem;}
.submit-btn{
  width:100%;
  padding:1rem;
  background: var(--primary-color);
  color:#fff;
  border:none;
  border-radius:25px;
  font-weight:600;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:0.5rem;
  transition: transform 0.3s, box-shadow 0.3s;
}
.submit-btn:hover{transform:scale(1.03); box-shadow:0 6px 20px rgba(255,165,0,0.4);}
.loader{
  width:30px;
  height:30px;
  border:4px solid #fff;
  border-top:4px solid rgba(255,165,0,0.7);
  border-radius:50%;
  animation: spin 1s linear infinite;
  display:none;
  position:absolute;
  right:15px;
  top:50%;
  transform:translateY(-50%);
}

/* Notification */
.notification{
  max-width:900px;
  margin:1rem auto;
  padding:1rem;
  background:#ffebcc;
  color:#cc6600;
  font-weight:600;
  text-align:center;
  border-radius:10px;
  display:none;
  animation: slideIn 0.5s ease;
}

/* History Table */
.history-table-container{
  overflow-x:auto;
  margin-top:2rem;
}
.history-table{
  width:100%;
  border-collapse:collapse;
  min-width:600px;
}
.history-table th, .history-table td{
  border:1px solid #ddd;
  padding:0.8rem;
  text-align:center;
}
.history-table th{background: var(--primary-color); color:#fff; font-weight:600;}
.status-pending{color:#ff9900; font-weight:600;}
.status-approved{color:green; font-weight:600;}
.status-rejected{color:red; font-weight:600;}

/* Footer */
footer{
  background: #fff5e6;
  padding: 1.5rem 2rem;
  text-align: center;
  font-size: 0.9rem;
  color: #555;
}

@keyframes fadeIn{from{opacity:0;} to{opacity:1;}}
@keyframes slideIn{from{opacity:0; transform:translateY(-20px);} to{opacity:1; transform:translateY(0);}}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
@media(max-width:768px){
  .invest-container{margin:1rem;}
  .history-table th, .history-table td{padding:0.5rem; font-size:0.9rem;}
}
</style>
</head>
<body>

<!-- Page Loader -->
<div id="pageLoader">
  <div class="spinner"></div>
  <div class="text">Loading Invest Page...</div>
</div>

<header>
  <div class="logo">InvestPro<br><small>Roshan Pakistan</small></div>
  <a href="dashboard.html" class="dashboard-btn"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
</header>

<main>
<div class="invest-container animate__animated animate__fadeIn">
  <h2><i class="fa-solid fa-wallet"></i> Invest Now</h2>

  <div id="paymentMethodsBox"></div>
  <div class="notification" id="notification">Message here</div>

  <div class="form-group">
    <label for="name"><i class="fa-solid fa-user"></i> Name</label>
    <input type="text" id="name" placeholder="Enter your name" required>
  </div>

  <div class="form-group">
    <label for="number"><i class="fa-solid fa-phone"></i> Number</label>
    <input type="text" id="number" placeholder="Enter your mobile number" required>
  </div>

  <div class="form-group">
    <label for="type"><i class="fa-solid fa-credit-card"></i> Payment Type</label>
    <select id="type" required>
      <option value="">Select</option>
      <option value="JazzCash">JazzCash</option>
      <option value="EasyPaisa">EasyPaisa</option>
      <option value="Bank">Bank</option>
    </select>
  </div>

  <div class="form-group">
    <label><i class="fa-solid fa-money-bill"></i> Amount (PKR)</label>
    <input type="number" value="200" disabled>
  </div>

  <div class="form-group">
    <label><i class="fa-solid fa-image"></i> Upload Image (optional)</label>
    <input type="file" id="proof" accept="image/*" capture="environment">
  </div>

  <div class="btn-container">
    <button class="submit-btn" id="submitBtn">
      <i class="fa-solid fa-paper-plane"></i> Send Investment Request
      <div class="loader" id="loader"></div>
    </button>
  </div>

  <div class="history-table-container">
    <table class="history-table animate__animated animate__fadeInUp" id="historyTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Amount (PKR)</th>
          <th>Type</th>
          <th>Status</th>
          <th>Proof</th>
        </tr>
      </thead>
      <tbody id="historyBody">
        <tr><td colspan="5">Loading...</td></tr>
      </tbody>
    </table>
  </div>
</div>
</main>

<footer>
  &copy; 2025 InvestPro. All rights reserved.
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
import { getDatabase, ref, get, push, set, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC-VDLeGkVEHRx3bu1SUAwvv8t6Y6Fz0Dg",
  authDomain: "khanbaba-2d4e5.firebaseapp.com",
  databaseURL: "https://khanbaba-2d4e5-default-rtdb.firebaseio.com",
  projectId: "khanbaba-2d4e5"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const notification = document.getElementById('notification');
const submitBtn = document.getElementById('submitBtn');
const loader = document.getElementById('loader');
const historyBody = document.getElementById('historyBody');
const pageLoader = document.getElementById('pageLoader');
const mainContent = document.querySelector('main');

let currentUser = null;

function showNotification(msg){
  notification.innerText = msg;
  notification.style.display='block';
  setTimeout(()=>{ notification.style.display='none'; },4000);
}

onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user;
    fetchHistory();
    pageLoader.style.display='none';
    mainContent.style.opacity='1';
  } else window.location.href='login.html';
});

submitBtn.addEventListener('click', async ()=>{
  const name = document.getElementById('name').value.trim();
  const number = document.getElementById('number').value.trim();
  const type = document.getElementById('type').value;
  const proofFile = document.getElementById('proof').files[0] || null;

  if(!name || !number || !type){
    showNotification('Please fill all required fields');
    return;
  }

  loader.style.display='inline-block';
  submitBtn.disabled=true;

  let proofBase64 = null;
  if(proofFile){
    proofBase64 = await new Promise((resolve)=>{
      const reader = new FileReader();
      reader.onload = e => resolve(e.target.result);
      reader.readAsDataURL(proofFile);
    });
  }

  // Send request to server to create JazzCash payment
  try{
    const res = await fetch('/createPayment', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({
        name, number, type, amount:200
      })
    });
    const data = await res.json();
    if(data.status==='success'){
      // Save to Firebase
      const newRef = push(ref(db,'investments/'+currentUser.uid));
      await set(newRef,{
        name, number, type, amount:200, status:'Pending', date:new Date().toLocaleString(),
        proof: proofBase64
      });
      showNotification('Payment request created! Redirecting to JazzCash...');
      setTimeout(()=>{ window.location.href = data.paymentUrl; },1000);
      fetchHistory();
    } else showNotification('Failed to create payment. Try again.');
  } catch(err){
    console.error(err);
    showNotification('Server error. Try again.');
  } finally{
    loader.style.display='none';
    submitBtn.disabled=false;
  }
});

function fetchHistory(){
  if(!currentUser) return;
  onValue(ref(db,'investments/'+currentUser.uid),snap=>{
    const data = snap.val() || {};
    historyBody.innerHTML='';
    const keys = Object.keys(data);
    if(keys.length===0){
      historyBody.innerHTML='<tr><td colspan="5">No investment history yet.</td></tr>';
    } else {
      keys.forEach(k=>{
        const inv = data[k];
        let statusClass='';
        if(inv.status==='Pending') statusClass='status-pending';
        else if(inv.status==='Approved') statusClass='status-approved';
        else if(inv.status==='Rejected') statusClass='status-rejected';
        let proofHTML = inv.proof ? `<img src="${inv.proof}" width="50" style="border-radius:5px;">` : 'No Proof';
        historyBody.innerHTML += `<tr>
          <td>${inv.date}</td>
          <td>${inv.amount}</td>
          <td>${inv.type}</td>
          <td class="${statusClass}">${inv.status}</td>
          <td>${proofHTML}</td>
        </tr>`;
      });
    }
  });
}
</script>
</body>
</html>
